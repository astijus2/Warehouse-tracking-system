<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    .number-btn { transition: all .2s ease; }
    .number-btn:active { transform: scale(.96); background-color: #e5e7eb; }
    .input-display { letter-spacing: .15em; min-width: 1em; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-6xl bg-white rounded-2xl shadow-xl p-6 md:p-8 flex flex-col relative">
    <!-- Top bar -->
    <div class="flex items-center justify-between mb-6">
      <a href="History-logs.html" class="px-4 py-2 rounded-full bg-blue-50 text-blue-700 hover:bg-blue-100 flex items-center gap-2">
        <i data-feather="clock"></i><span>Istorija</span>
      </a>
      <div class="bg-blue-100 text-blue-800 px-4 py-2 rounded-lg font-medium">
        Daktaras/-ė: <span id="doctorName">—</span>
      </div>
    </div>

    <!-- Header row -->
    <div class="flex items-center justify-between mb-4">
      <button onclick="history.back()" class="p-2 rounded-full hover:bg-gray-100" aria-label="Back">
        <i data-feather="arrow-left"></i>
      </button>
      <div class="flex items-center gap-3">
        <div id="toolIcon" class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center"></div>
        <h1 id="toolTitle" class="text-2xl font-semibold text-gray-800">—</h1>
      </div>
      <div class="w-9 h-9"></div>
    </div>

    <!-- Two-column content -->
    <main id="stage" class="flex flex-1 gap-3 items-stretch min-h-[60vh]">
      <!-- LEFT: Recent history -->
      <div class="flex-1 flex flex-col min-h-0">
        <div class="bg-white rounded-xl shadow-md p-5 flex-1 flex flex-col min-h-0">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Paskutiniai įrašai</h2>
            <!-- Toggle: no navigation, just switches filter -->
            <a id="viewAllLink" class="text-sm text-blue-600 hover:underline" href="#">Rodyti visus įrašus</a>
          </div>
          <!-- grows to fill and scrolls -->
          <ul id="toolLogList" class="flex-1 space-y-2 overflow-y-auto max-h-[400px]"></ul>
        </div>
      </div>

      <!-- RIGHT: Totals + keypad -->
      <div class="flex-1 flex flex-col min-h-0">
        <div class="bg-white rounded-xl shadow-md p-5 flex-1 flex flex-col">
          <!-- Totals -->
          <div class="flex items-center justify-between mb-3">
            <span class="text-lg font-medium">Iš viso sandėlyje:</span>
            <span id="total" class="text-2xl font-bold">0</span>
          </div>

          <!-- Keypad -->
          <div>
            <div class="flex items-center justify-center gap-4 mb-3">
              <button id="removeBtn" class="p-3 rounded-full bg-red-100 hover:bg-red-200 text-red-600" title="Išvežta">
                <i data-feather="minus-circle"></i>
              </button>
              <div class="bg-gray-100 rounded-lg p-4 w-64 text-center" tabindex="-1" id="displayContainer">
                <p id="display" class="text-3xl font-mono input-display text-gray-800 h-10">0</p>
              </div>
              <button id="addBtn" class="p-3 rounded-full bg-green-100 hover:bg-green-200 text-green-600" title="Pridėta">
                <i data-feather="plus-circle"></i>
              </button>
            </div>

            <div class="grid grid-cols-3 gap-3">
              <!-- buttons -->
              <button class="number-btn bg-gray-100 hover:bg-gray-200 py-4 rounded-lg text-xl" data-number="1">1</button>
              <button class="number-btn bg-gray-100 hover:bg-gray-200 py-4 rounded-lg text-xl" data-number="2">2</button>
              <button class="number-btn bg-gray-100 hover:bg-gray-200 py-4 rounded-lg text-xl" data-number="3">3</button>
              <button class="number-btn bg-gray-100 hover:bg-gray-200 py-4 rounded-lg text-xl" data-number="4">4</button>
              <button class="number-btn bg-gray-100 hover:bg-gray-200 py-4 rounded-lg text-xl" data-number="5">5</button>
              <button class="number-btn bg-gray-100 hover:bg-gray-200 py-4 rounded-lg text-xl" data-number="6">6</button>
              <button class="number-btn bg-gray-100 hover:bg-gray-200 py-4 rounded-lg text-xl" data-number="7">7</button>
              <button class="number-btn bg-gray-100 hover:bg-gray-200 py-4 rounded-lg text-xl" data-number="8">8</button>
              <button class="number-btn bg-gray-100 hover:bg-gray-200 py-4 rounded-lg text-xl" data-number="9">9</button>
              <button class="number-btn bg-gray-100 hover:bg-gray-200 py-4 rounded-lg text-xl col-span-2" data-number="0">0</button>
              <button class="number-btn bg-gray-200 hover:bg-gray-300 py-4 rounded-lg text-xl flex items-center justify-center" data-number="back" title="Backspace">
                <i data-feather="delete"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Error Modal -->
  <div id="errorModal" class="fixed inset-0 z-50 hidden">
    <!-- Backdrop -->
    <div id="errorModalBackdrop" class="absolute inset-0 bg-black/40"></div>

    <!-- Dialog -->
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-sm bg-white rounded-xl shadow-xl p-5 md:p-6 animate-[fadeIn_.15s_ease-out]">
        <div class="flex items-center gap-3 mb-3">
          <div class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center">
            <i data-feather="alert-triangle" class="text-red-500"></i>
          </div>
          <h3 class="text-lg font-semibold text-gray-800">Veiksmas negalimas</h3>
        </div>

        <p id="errorModalMessage" class="text-gray-600 mb-5">
          Negali išimti daugiau nei yra sandėlyje.
        </p>

        <div class="flex justify-end">
          <button id="errorModalOk"
                  class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700
                         focus:outline-none focus:ring-2 focus:ring-blue-400">
            OK
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tool metadata (id -> name/icon). Keep in sync with main page.
    const TOOL_META = {
      skalpelis:    { name: 'Skalpelis',           icon: 'activity', color: 'red' },
      zirkles:      { name: 'Žirklės',             icon: 'settings', color: 'blue' },
      pincetas:     { name: 'Pincetas',            icon: 'feather',  color: 'green' },
      retraktorius: { name: 'Retraktorius',        icon: 'aperture', color: 'purple' },
      pjuklas:      { name: 'Pjūklas',             icon: 'tool',     color: 'orange' },
      laparoskopas: { name: 'Laparoskopas',        icon: 'cpu',      color: 'pink' },
      kocher:       { name: 'Kocher spaustukas',   icon: 'anchor'   },
      mosquito:     { name: 'Mosquito spaustukas', icon: 'zap'      },
      adatu:        { name: 'Adatų laikiklis',     icon: 'align-center' },
      osteotomas:   { name: 'Osteotomas',          icon: 'square'   },
      dilatorius:   { name: 'Dilatorius',          icon: 'sliders'  },
      kirptuvas:    { name: 'Siūlų kirptuvas',     icon: 'scissors' }
    };

    // URL param
    const params = new URLSearchParams(window.location.search);
    const toolId = params.get('tool');
    const meta   = TOOL_META[toolId] || { name: 'Nežinomas įrankis', icon: 'box' };

    // DOM
    const toolTitle   = document.getElementById('toolTitle');
    const toolIcon    = document.getElementById('toolIcon');
    const totalEl     = document.getElementById('total');
    const display     = document.getElementById('display');
    const addBtn      = document.getElementById('addBtn');
    const removeBtn   = document.getElementById('removeBtn');
    const doctorEl    = document.getElementById('doctorName');
    const toolLogList = document.getElementById('toolLogList');
    const viewAllLink = document.getElementById('viewAllLink');

    // Storage keys
    const TOTAL_KEY = `${toolId}:total`;
    const LOGS_KEY  = 'toolLogs';

    // State
    let currentInput = '0';
    let showAllHistory = false; // false = only this tool, true = all tools

    // ===== Modal helpers =====
    function openErrorModal(message) {
      const modal  = document.getElementById('errorModal');
      const msgEl  = document.getElementById('errorModalMessage');
      const okBtn  = document.getElementById('errorModalOk');
      const backdp = document.getElementById('errorModalBackdrop');
      const returnFocusEl = document.getElementById('displayContainer');

      msgEl.textContent = message || 'Įvyko klaida.';
      modal.classList.remove('hidden');

      // focus OK for keyboard users
      setTimeout(() => okBtn.focus(), 0);

      // close handlers
      function close() {
        modal.classList.add('hidden');
        okBtn.removeEventListener('click', close);
        backdp.removeEventListener('click', close);
        document.removeEventListener('keydown', onKey);
        // return focus near the input
        returnFocusEl && returnFocusEl.focus && returnFocusEl.focus();
      }
      function onKey(e) { if (e.key === 'Escape' || e.key === 'Enter' || e.key === ' ') close(); }

      okBtn.addEventListener('click', close);
      backdp.addEventListener('click', close);     // click backdrop to close
      document.addEventListener('keydown', onKey); // Esc/Enter/Space
    }

    document.addEventListener('DOMContentLoaded', () => {
      // top-right doctor name
      doctorEl.textContent = localStorage.getItem('doctorName') || '—';

      // title & icon
      toolTitle.textContent = meta.name;
      toolIcon.innerHTML = `<i data-feather="${meta.icon || 'box'}" class="w-6 h-6 text-blue-600"></i>`;
      feather.replace();

      // totals
      totalEl.textContent = localStorage.getItem(TOTAL_KEY) || '0';

      // keypad digits
      document.querySelectorAll('.number-btn').forEach(b => {
        b.addEventListener('click', () => {
          const n = b.getAttribute('data-number');
          if (n === 'back') {
            currentInput = currentInput.length > 1 ? currentInput.slice(0, -1) : '0';
          } else {
            currentInput = currentInput === '0' ? n : currentInput + n;
          }
          display.textContent = currentInput;
        });
      });

      // actions
      addBtn.addEventListener('click', () => applyChange(+1));
      removeBtn.addEventListener('click', () => applyChange(-1));

      // toggle "view all" in-place (no navigation)
      viewAllLink.textContent = showAllHistory ? 'Rodyti tik šį įrankį' : 'Rodyti visus įrašus';
      viewAllLink.addEventListener('click', (e) => {
        e.preventDefault();
        showAllHistory = !showAllHistory;
        viewAllLink.textContent = showAllHistory ? 'Rodyti tik šį įrankį' : 'Rodyti visus įrašus';
        renderToolLogs();
      });

      // initial render
      renderToolLogs();
    });

    function applyChange(sign) {
      const amount = parseInt(currentInput, 10) || 0;
      if (amount === 0) { currentInput = '0'; display.textContent = '0'; return; }

      const current = parseInt(totalEl.textContent, 10) || 0;

      // Prevent removing more than available
      if (sign < 0 && amount > current) {
        openErrorModal('Negali išimti daugiau nei yra sandėlyje!');
        currentInput = '0';
        display.textContent = '0';
        return;
      }

      const next = current + sign * amount;

      totalEl.textContent = String(next);
      localStorage.setItem(TOTAL_KEY, String(next));

      addLog({
        toolId,
        toolName: meta.name,
        action: sign > 0 ? 'Pridėta' : 'Išvežta',
        amount,
        total: next
      });

      currentInput = '0';
      display.textContent = '0';
      renderToolLogs();
    }

    function addLog(entry) {
      const logs = JSON.parse(localStorage.getItem(LOGS_KEY) || '[]');
      const doctorName = localStorage.getItem('doctorName') || '—';
      logs.push({
        id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
        timestamp: Date.now(),
        doctorName,
        ...entry
      });
      localStorage.setItem(LOGS_KEY, JSON.stringify(logs));
    }

    function renderToolLogs() {
      const all = JSON.parse(localStorage.getItem(LOGS_KEY) || '[]')
        .sort((a,b) => b.timestamp - a.timestamp);

      const filtered = showAllHistory ? all : all.filter(l => l.toolId === toolId);
      const logs = filtered.slice(0, 10);

      toolLogList.innerHTML = '';
      logs.forEach(l => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center bg-gray-50 px-3 py-2 rounded';

        // Show a small tool tag when viewing all tools
        const toolTag = showAllHistory
          ? `<span class="text-xs px-2 py-0.5 rounded bg-blue-50 text-blue-700">${l.toolName || l.toolId || '—'}</span>`
          : '';

        li.innerHTML = `
          <span class="text-sm flex items-center gap-2">
            ${toolTag}
            ${new Date(l.timestamp).toLocaleString()}
          </span>
          <span class="text-sm">${l.action} <strong>${l.amount}</strong> → ${l.total}</span>
          <span class="text-xs text-gray-500">${l.doctorName || '—'}</span>
        `;
        toolLogList.appendChild(li);
      });
    }

    (function() {
  const AUTH_KEY = 'auth';
  const auth = sessionStorage.getItem(AUTH_KEY);
  if (!auth) { window.location.href = 'Auth.html'; return; }

  document.addEventListener('DOMContentLoaded', () => {
    const doctorEl = document.getElementById('doctorName');
    if (!doctorEl) return;
    const container = doctorEl.parentElement;
    if (!container) return;
    container.classList.add('flex','items-center','gap-2');

    if (document.getElementById('logoutBtn')) return;
    const btn = document.createElement('button');
    btn.id = 'logoutBtn';
    btn.className = 'ml-2 px-2 py-1 rounded bg-red-600 text-white hover:bg-red-700 text-xs';
    btn.innerHTML = '<i data-feather="log-out" class="inline w-4 h-4 align-[-2px]"></i> Logout';
    btn.addEventListener('click', () => {
      sessionStorage.removeItem(AUTH_KEY);
      sessionStorage.removeItem('doctorName');
      localStorage.removeItem('auth');         // legacy cleanup
      localStorage.removeItem('doctorName');   // avoid stale name
      window.location.href = 'Auth.html';
    });
    container.appendChild(btn);

    const name = sessionStorage.getItem('doctorName') || localStorage.getItem('doctorName') || '—';
    doctorEl.textContent = name;
    if (window.feather) feather.replace();
  });
})();
  </script>
</body>
</html>
