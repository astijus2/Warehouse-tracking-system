<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Demo Auth • Clinic Warehouse</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    @keyframes pop { from { transform: scale(.98); opacity: .0 } to { transform: scale(1); opacity: 1 } }
    .pop { animation: pop .15s ease-out }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <main class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 md:p-8 pop">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
          <i data-feather="lock" class="w-5 h-5 text-blue-600"></i>
        </div>
        <h1 class="text-xl md:text-2xl font-semibold text-gray-800">Prisijungimas ir Registracija</h1>
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex items-center gap-4 mb-4">
      <button id="tabLogin" class="tab bg-blue-600 rounded-full text-white">Prisijungti</button>
      <button id="tabRegister" class="tab bg-gray-100 rounded-full text-gray-700">Registruotis</button>
    </div>

    <!-- Forms container -->
    <div class="grid grid-cols-1 gap-6">
      <!-- LOGIN -->
      <form id="formLogin" class="space-y-4" autocomplete="on">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-600 mb-1" for="loginFirst">Vardas</label>
            <input id="loginFirst" type="text" class="input rounded-md border bg-gray-100" placeholder="Jane" autocomplete="given-name" required />
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1" for="loginLast">Pavardė</label>
            <input id="loginLast" type="text" class="input rounded-md border bg-gray-100" placeholder="Doe" autocomplete="family-name" required />
          </div>
        </div>
        <div>
          <label class="block text-sm  text-gray-600 mb-1" for="loginPassword">Slaptažodis</label>
          <div class="relative">
            <input id="loginPassword" type="password" class="input pr-10 rounded-md border bg-gray-100" placeholder="••••••••" minlength="6" required />
            <button type="button" data-toggle="loginPassword" class="absolute ml-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-gray-100" title="Show/Hide">
              <i data-feather="eye"></i>
            </button>
          </div>
        </div>
        <div id="loginError" class="hidden text-sm text-red-600"></div>
        <div class="flex items-center justify-between">
          <button class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700" type="submit">Prisijungti</button>
          <p class="text-xs text-gray-500">• Local demo only •</p>
        </div>
      </form>

      <!-- REGISTER -->
      <form id="formRegister" class="hidden space-y-4" autocomplete="on">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm  text-gray-600 mb-1" for="regFirst">Vardas</label>
            <input id="regFirst" type="text" class="input rounded-md border bg-gray-100" placeholder="Jane" autocomplete="given-name" required />
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1" for="regLast">Pavardė</label>
            <input id="regLast" type="text" class="input rounded-md border bg-gray-100" placeholder="Doe" autocomplete="family-name" required />
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-600 mb-1" for="regPassword">Slaptažodis</label>
            <div class="relative">
              <input id="regPassword" type="password" class="input pr-10 rounded-md border bg-gray-100" placeholder="At least 6 characters" minlength="6" required />
              <button type="button" data-toggle="regPassword" class="absolute ml-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-gray-100" title="Show/Hide">
                <i data-feather="eye"></i>
              </button>
            </div>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1" for="regPassword2">Patvirtink slaptažodį</label>
            <div class="relative">
              <input id="regPassword2" type="password" class="input rounded-md border bg-gray-100 pr-10" placeholder="Repeat password" minlength="6" required />
              <button type="button" data-toggle="regPassword2" class="absolute ml-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-gray-100" title="Show/Hide">
                <i data-feather="eye"></i>
              </button>
            </div>
          </div>
        </div>
        <div id="regError" class="hidden text-sm text-red-600"></div>
        <div class="flex items-center justify-between">
          <button class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700" type="submit">Sukurti paskyrą</button>
          <p class="text-xs text-gray-500">• Local demo only •</p>
        </div>
      </form>
    </div>
  </main>

  <script>
    feather.replace();

    // ===== Session-only auth =====
    // Use sessionStorage for auth so every time the files are reopened, login is required.
    const USERS_KEY = 'users';       // array of users (persisted)
    const AUTH_KEY  = 'auth';        // current session (session-only)
    const authStore = sessionStorage; // <— session scope

    // On auth page load, clear any old session so user must log in again
    try {
      authStore.removeItem(AUTH_KEY);
      authStore.removeItem('doctorName');
      // clean up legacy keys from older versions
      localStorage.removeItem('auth');
    } catch {}

    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);

    function loadUsers() {
      try { return JSON.parse(localStorage.getItem(USERS_KEY) || '[]'); }
      catch { return []; }
    }
    function saveUsers(list) {
      localStorage.setItem(USERS_KEY, JSON.stringify(list));
    }
    async function sha256(text) {
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
    }
    function uid() {
      const n = crypto.getRandomValues(new Uint32Array(1))[0].toString(16);
      return `${Date.now().toString(16)}-${n}`;
    }
    function show(el) { el.classList.remove('hidden'); }
    function hide(el) { el.classList.add('hidden'); }
    function setDoctorName(name) {
      // Keep both stores in sync so existing pages that read localStorage keep working,
      // but the guard will still require a session.
      authStore.setItem('doctorName', name);
      localStorage.setItem('doctorName', name);
    }

    // ===== Tabs =====
    const tabLogin = $('tabLogin');
    const tabRegister = $('tabRegister');
    const formLogin = $('formLogin');
    const formRegister = $('formRegister');

function setTab(which) {
  const loginActive = which === 'login';
  const base = 'tab px-4 py-2 rounded-full text-sm';
  tabLogin.className    = base + ' ' + (loginActive ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700');
  tabRegister.className = base + ' ' + (!loginActive ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700');
  formLogin.classList.toggle('hidden', !loginActive);
  formRegister.classList.toggle('hidden', loginActive);
}

    tabLogin.addEventListener('click', () => setTab('login'));
    tabRegister.addEventListener('click', () => setTab('register'));

    // ===== Show/hide password buttons =====
    document.querySelectorAll('[data-toggle]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-toggle');
        const input = $(id);
        input.type = input.type === 'password' ? 'text' : 'password';
      });
    });

    // ===== Helper: find user by name + password =====
    async function findUserByCreds(first, last, password, users) {
      const hash = await sha256(password);
      return users.find(u => u.first?.toLowerCase() === first.toLowerCase() && u.last?.toLowerCase() === last.toLowerCase() && u.passwordHash === hash) || null;
    }

    // ===== Login submit =====
    const loginError = $('loginError');
    formLogin.addEventListener('submit', async (e) => {
      e.preventDefault();
      hide(loginError);
      const first = $('loginFirst').value.trim();
      const last  = $('loginLast').value.trim();
      const pass  = $('loginPassword').value;

      const users = loadUsers();
      const user = await findUserByCreds(first, last, pass, users);
      if (!user) {
        loginError.textContent = 'No account for this name/password.';
        show(loginError);
        return;
      }

      // Save session (sessionStorage) + doctor name for app header
      authStore.setItem(AUTH_KEY, JSON.stringify({ userId: user.id, first: user.first, last: user.last, name: user.name, loginAt: Date.now() }));
      setDoctorName(user.name);
      window.location.href = 'Index.html';
    });

    // ===== Register submit =====
    const regError = $('regError');
    formRegister.addEventListener('submit', async (e) => {
      e.preventDefault();
      hide(regError);
      const first = $('regFirst').value.trim();
      const last  = $('regLast').value.trim();
      const p1 = $('regPassword').value;
      const p2 = $('regPassword2').value;

      if (first.length < 1 || last.length < 1) { regError.textContent = 'Please enter first and last name.'; show(regError); return; }
      if (p1.length < 6) { regError.textContent = 'Password must be at least 6 characters.'; show(regError); return; }
      if (p1 !== p2) { regError.textContent = 'Passwords do not match.'; show(regError); return; }

      const users = loadUsers();
      // Allow duplicate names; password differentiates the accounts.

      const user = {
        id: uid(),
        first,
        last,
        name: `${first} ${last}`,
        passwordHash: await sha256(p1),
        createdAt: Date.now()
      };
      users.push(user);
      saveUsers(users);

      // Auto sign-in (sessionStorage) and set doctor name
      authStore.setItem(AUTH_KEY, JSON.stringify({ userId: user.id, first: user.first, last: user.last, name: user.name, loginAt: Date.now() }));
      setDoctorName(user.name);
      window.location.href = 'Index.html';
    });

    // ===== Tiny test harness (non-destructive) =====
    function shouldRunTests() {
      return new URLSearchParams(location.search).get('tests') === '1' || location.hash.includes('tests') || localStorage.getItem('RUN_TESTS') === '1';
    }
    async function runTests() {
      const results = [];
      const pass = (name) => results.push({ name, ok: true });
      const fail = (name, msg) => results.push({ name, ok: false, msg });

      try {
        const h = await sha256('abc');
        (h === 'ba7816bf8f01cfea414140de5dae2223b00361a396177a9cb410ff61f20015ad') ? pass('sha256("abc")') : fail('sha256("abc")', h);

        const a = uid(), b = uid();
        (/^[0-9a-f]+\-/.test(a) && a !== b) ? pass('uid() format & uniqueness') : fail('uid() format & uniqueness', `${a} vs ${b}`);

        setTab('register');
        (!formRegister.classList.contains('hidden') && formLogin.classList.contains('hidden')) ? pass('setTab("register") shows register') : fail('setTab("register")');
        setTab('login');
        (!formLogin.classList.contains('hidden') && formRegister.classList.contains('hidden')) ? pass('setTab("login") shows login') : fail('setTab("login")');

        const users = [
          { id: '1', first: 'Jane', last: 'Doe', passwordHash: await sha256('pw1'), name: 'Jane Doe' },
          { id: '2', first: 'Jane', last: 'Doe', passwordHash: await sha256('pw2'), name: 'Jane Doe' }
        ];
        const u1 = await findUserByCreds('Jane','Doe','pw1', users);
        const u2 = await findUserByCreds('Jane','Doe','pw2', users);
        (u1?.id === '1' && u2?.id === '2') ? pass('duplicate names resolve by password') : fail('duplicate names resolve by password', `${u1?.id}/${u2?.id}`);

      } catch (e) {
        fail('unexpected error in tests', e.message || String(e));
      }

      const ok = results.every(r => r.ok);
      console.group('%cAuth demo tests', `color:${ok? 'green':'red'}; font-weight:bold`);
      results.forEach(r => { if (r.ok) console.log('✅', r.name); else console.error('❌', r.name, r.msg || ''); });
      console.groupEnd();

      const badge = document.createElement('div');
      badge.id = 'testStatus';
      badge.className = 'fixed bottom-3 right-3 text-xs px-2 py-1 rounded-lg shadow bg-white border';
      badge.textContent = ok ? 'Tests: PASS' : 'Tests: FAIL';
      document.body.appendChild(badge);
    }
    if (shouldRunTests()) { runTests(); }

    // Default tab
    setTab('login');
  </script>
</body>
</html>
